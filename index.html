<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Space Ultimate</title>
    <style>
        :root {
            --bg: #f0f2f5; --side: #ffffff; --card: #ffffff; --text: #1c1e21;
            --primary: #e94560; --border: #ddd; --input: #f0f2f5;
        }
        [data-theme="dark"] {
            --bg: #1a1a2e; --side: #16213e; --card: #0f3460; --text: #e9e9e9;
            --primary: #e94560; --border: #222; --input: #1a1a2e;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; transition: 0.3s; }
        
        /* Sidebar */
        aside { width: 280px; background: var(--side); padding: 20px; border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); text-align: center; margin-bottom: 30px; letter-spacing: 1px; }
        .nav-link { padding: 12px 15px; cursor: pointer; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; font-weight: 600; transition: 0.2s; color: var(--text); opacity: 0.8; }
        .nav-link:hover { background: var(--primary); color: white; opacity: 1; }
        .nav-link.active { background: var(--primary); color: white; opacity: 1; }

        /* Content */
        main { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 650px; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border); }
        
        /* Profile & Post */
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #ddd; border: 2px solid var(--primary); }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .post-img { width: 100%; border-radius: 15px; margin-top: 10px; }
        
        input, textarea, select { background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 12px; width: 100%; box-sizing: border-box; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .btn:hover { transform: scale(1.02); filter: brightness(1.1); }
        
        .replies { background: rgba(0,0,0,0.03); border-radius: 15px; padding: 15px; margin-top: 15px; }
        .hidden { display: none !important; }
    </style>
</head>
<body data-theme="light">

    <aside id="sidebar" class="hidden">
        <div class="logo">NOVA SPACE</div>
        <div class="nav-link active" onclick="window.switchTab('home', this)">üè† –ì–ª–∞–≤–Ω–∞—è</div>
        <div class="nav-link" onclick="window.switchTab('popular', this)">üî• –¢–æ–ø 100</div>
        <div class="nav-link" onclick="window.switchTab('following', this)">üë• –ü–æ–¥–ø–∏—Å–∫–∏</div>
        <div class="nav-link" onclick="window.switchTab('messages', this)">üí¨ –ß–∞—Ç—ã</div>
        <div class="nav-link" onclick="window.switchTab('settings', this)">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div style="margin-top:auto" class="nav-link" onclick="window.logout()">üö™ –í—ã—Ö–æ–¥</div>
    </aside>

    <main>
        <div id="auth-section" class="card" style="width:350px; margin-top:100px; text-align:center">
            <h2 style="color:var(--primary)">–í–æ–π—Ç–∏</h2>
            <input type="email" id="email" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" style="margin-bottom:10px">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom:20px">
            <button class="btn" style="width:100%" onclick="window.auth('login')">–ü–æ–µ—Ö–∞–ª–∏!</button>
            <p onclick="window.auth('reg')" style="cursor:pointer; opacity:0.7; font-size:14px; margin-top:15px">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
        </div>

        <div id="content-section" class="container hidden">
            <div id="tab-home" class="tab-content">
                <div class="card">
                    <div class="post-header">
                        <img id="my-small-av" class="avatar">
                        <textarea id="post-text" placeholder="–û —á–µ–º –≤—ã –¥—É–º–∞–µ—Ç–µ?" style="height:50px"></textarea>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <label style="cursor:pointer; font-size:20px">üñºÔ∏è<input type="file" id="post-file" style="display:none"></label>
                        <button class="btn" onclick="window.createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                <div id="posts-list"></div>
            </div>

            <div id="tab-popular" class="tab-content hidden">
                <h2 style="text-align:center">üî• –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø–æ—Å—Ç—ã</h2>
                <div id="popular-list"></div>
            </div>

            <div id="tab-settings" class="tab-content hidden card">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
                <p>–ù–∏–∫–Ω–µ–π–º:</p>
                <input type="text" id="set-name" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫">
                <p style="margin-top:20px">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:</p>
                <select id="theme-select" onchange="window.changeTheme(this.value)">
                    <option value="light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</option>
                    <option value="dark">üåô –¢–µ–º–Ω–∞—è</option>
                </select>
                <button class="btn" style="margin-top:20px; width:100%" onclick="window.saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
            
            <div id="tab-following" class="tab-content hidden"><h3>üë• –í–∞—à–∏ –∫—É–º–∏—Ä—ã</h3><div id="following-list"></div></div>
            <div id="tab-messages" class="tab-content hidden"><h3>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</h3></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWfc3TzdVLaiwOhUrEfDaGsEHrUInzuJM",
            authDomain: "doodle-102.firebaseapp.com",
            projectId: "doodle-102",
            storageBucket: "doodle-102.firebasestorage.app",
            messagingSenderId: "296542303637",
            appId: "1:296542303637:web:950b3cbe547c6d10f3f29c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const IMGBB_KEY = "cfedaeb5c6bb179902b44ba10cb396cb";

        let userLocal = { name: '', following: [], theme: 'light' };

        window.auth = (t) => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            if(t==='reg') createUserWithEmailAndPassword(auth, e, p); else signInWithEmailAndPassword(auth, e, p);
        };
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async u => {
            if(u) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('content-section').classList.remove('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('my-small-av').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${u.uid}`;
                
                const ref = doc(db, "users", u.uid);
                onSnapshot(ref, d => {
                    if(d.exists()) {
                        userLocal = d.data();
                        document.body.setAttribute('data-theme', userLocal.theme || 'light');
                        document.getElementById('set-name').value = userLocal.name;
                    } else {
                        setDoc(ref, { name: u.email.split('@')[0], following: [], theme: 'light' });
                    }
                    loadPosts();
                });
            }
        });

        window.changeTheme = (v) => document.body.setAttribute('data-theme', v);
        
        window.saveSettings = async () => {
            const n = document.getElementById('set-name').value;
            const t = document.getElementById('theme-select').value;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { name: n, theme: t });
            alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        };

        async function upload(f) {
            const fd = new FormData(); fd.append("image", f);
            const r = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {method:"POST", body:fd});
            const j = await r.json(); return j.data.url;
        }

        window.createPost = async () => {
            const t = document.getElementById('post-text').value;
            const f = document.getElementById('post-file').files[0];
            if(!t && !f) return;
            let img = f ? await upload(f) : null;
            await addDoc(collection(db, "posts"), { 
                text: t, img, uid: auth.currentUser.uid, author: userLocal.name, 
                likes: 0, voters: [], createdAt: serverTimestamp() 
            });
            document.getElementById('post-text').value = "";
        };

        function loadPosts() {
            onSnapshot(query(collection(db, "posts"), orderBy("createdAt", "desc")), snap => {
                const posts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render(posts, 'posts-list');
                render(posts.filter(p => p.likes >= 100), 'popular-list');
                render(posts.filter(p => userLocal.following?.includes(p.uid)), 'following-list');
            });
        }

        function render(list, boxId) {
            const box = document.getElementById(boxId); box.innerHTML = list.length ? "" : "<p style='text-align:center;opacity:0.5'>–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ</p>";
            list.forEach(p => {
                const isF = userLocal.following?.includes(p.uid);
                const div = document.createElement('div'); div.className = 'card';
                div.innerHTML = `
                    <div class="post-header">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${p.uid}" class="avatar">
                        <div style="flex:1">
                            <div style="font-weight:700">${p.author}</div>
                            <div style="font-size:12px; opacity:0.6">${p.createdAt ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–ó–∞–≥—Ä—É–∑–∫–∞...'}</div>
                        </div>
                        ${p.uid !== auth.currentUser.uid ? `<button class="btn" style="padding:5px 10px; font-size:12px" onclick="window.follow('${p.uid}')">${isF?'–û—Ç–ø–∏—Å–∞—Ç—å—Å—è':'–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}</button>` : ''}
                    </div>
                    <div style="margin-bottom:15px">${p.text}</div>
                    ${p.img ? `<img src="${p.img}" class="post-img">` : ''}
                    <div style="margin-top:15px; display:flex; gap:15px">
                        <span style="cursor:pointer; font-weight:bold" onclick="window.like('${p.id}')">‚ù§Ô∏è ${p.likes}</span>
                        <span style="opacity:0.6">üí¨ –û—Ç–≤–µ—Ç—ã</span>
                    </div>
                    <div class="replies">
                        <div id="re-list-${p.id}"></div>
                        <div style="display:flex; gap:8px; margin-top:10px">
                            <input id="re-in-${p.id}" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å..." style="padding:8px">
                            <button class="btn" onclick="window.addReply('${p.id}')">üìé</button>
                        </div>
                    </div>`;
                box.appendChild(div);
                loadReplies(p.id);
            });
        }

        window.addReply = async (id) => {
            const i = document.getElementById(`re-in-${id}`);
            if(!i.value) return;
            await addDoc(collection(db, `posts/${id}/replies`), { text: i.value, author: userLocal.name, createdAt: serverTimestamp() });
            i.value = "";
        };

        window.loadReplies = (pid) => {
            onSnapshot(query(collection(db, `posts/${pid}/replies`), orderBy("createdAt", "asc")), s => {
                const b = document.getElementById(`re-list-${pid}`); b.innerHTML = "";
                s.forEach(d => {
                    const r = d.data();
                    b.innerHTML += `<div style="font-size:14px; margin-bottom:5px"><b>${r.author}:</b> ${r.text}</div>`;
                });
            });
        };

        window.like = async id => {
            const r = doc(db, "posts", id); const d = await getDoc(r);
            if(d.data().voters?.includes(auth.currentUser.uid)) return;
            await updateDoc(r, { likes: increment(1), voters: arrayUnion(auth.currentUser.uid) });
        };

        window.follow = async id => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { following: userLocal.following?.includes(id) ? arrayRemove(id) : arrayUnion(id) });
        };

        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            if(el) el.classList.add('active');
        };
    </script>
</body>
</html>