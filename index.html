<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Space Ultimate</title>
    <style>
        :root { --p: #ff4757; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        header { background: var(--card); padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #334155; }
        .container { width: 100%; max-width: 550px; margin: 0 auto; padding: 15px; flex: 1; }
        
        .card { background: var(--card); padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #334155; }
        input, textarea { width: 100%; padding: 12px; margin: 5px 0; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; outline: none; }
        .btn { background: var(--p); color: white; border: none; padding: 12px; width: 100%; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; background: #1e293b; padding: 5px; border-radius: 15px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; color: #94a3b8; border-radius: 12px; cursor: pointer; font-weight: 600; }
        .tab-btn.active { background: var(--p); color: white; }
        
        .post { background: var(--card); border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid #334155; animation: fadeIn 0.3s ease; }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #334155; border: 2px solid var(--p); cursor: pointer; }
        .post-img { width: 100%; border-radius: 15px; margin-top: 10px; border: 1px solid #334155; }
        
        .badge { background: #3b82f6; font-size: 11px; padding: 2px 8px; border-radius: 20px; margin-left: 5px; vertical-align: middle; }
        .hidden { display: none !important; }
        .admin-btn { color: #ef4444; background: none; border: none; font-size: 12px; cursor: pointer; float: right; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 900; letter-spacing: 1px;">NOVA <span id="lvlDisplay" style="color:var(--p)"></span></div>
    <div id="headerActions" class="hidden">
        <button onclick="signOutUser()" style="color:#94a3b8; background:none; border:none; cursor:pointer">Выход</button>
    </div>
</header>

<div class="container">
    <div id="authBox" class="card">
        <h2 style="margin-top:0">Добро пожаловать</h2>
        <input type="email" id="email" placeholder="Электронная почта">
        <input type="password" id="pass" placeholder="Пароль">
        <button class="btn" onclick="handleAuth('login')">Войти</button>
        <button class="btn" style="background:transparent; border: 1px solid #334155" onclick="handleAuth('reg')">Регистрация</button>
    </div>

    <div id="app" class="hidden">
        <div class="tabs">
            <button class="tab-btn active" id="btn-feed" onclick="setTab('feed')">Лента</button>
            <button class="tab-btn" id="btn-chats" onclick="setTab('chats')">Чаты</button>
            <button class="tab-btn" id="btn-profile" onclick="setTab('profile')">Профиль</button>
        </div>

        <div id="view-feed">
            <div class="card">
                <textarea id="postMsg" placeholder="Что нового?"></textarea>
                <div style="display:flex; gap:10px">
                    <input type="file" id="postImg" style="font-size:12px; border:none; background:none">
                    <button class="btn" style="width:120px" onclick="sendNewPost()">Пост</button>
                </div>
            </div>
            <div id="feedList"></div>
        </div>

        <div id="view-profile" class="hidden">
            <div class="card" style="text-align: center;">
                <img id="myAvatar" class="avatar" style="width:120px; height:120px; margin-bottom:15px">
                <h2 id="myUser">User</h2>
                <p style="color:#94a3b8">Опыт: <span id="myXP">0</span> XP</p>
                <hr style="border:0; border-top:1px solid #334155; margin:20px 0">
                <label style="font-size:13px; color:#94a3b8">Изменить аватар:</label>
                <input type="file" id="newAvatar">
                <button class="btn" onclick="saveAvatar()">Сохранить фото</button>
            </div>
        </div>

        <div id="view-chats" class="hidden">
            <div class="card">
                <h3>Твои сообщения</h3>
                <p style="color:#94a3b8; font-size:14px">Чтобы начать чат, нажми на аватар пользователя в ленте.</p>
                <div id="chatHistory"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCWfc3TzdVLaiwOhUrEfDaGsEHrUInzuJM",
        authDomain: "doodle-102.firebaseapp.com",
        projectId: "doodle-102",
        storageBucket: "doodle-102.firebasestorage.app",
        messagingSenderId: "296542303637",
        appId: "1:296542303637:web:950b3cbe547c6d10f3f29c"
    };

    const IMGBB_KEY = "cfedaeb5c6bb179902b44ba10cb396cb";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let profile = null;

    // ВХОД / РЕГА
    window.handleAuth = (type) => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        if(type === 'reg') createUserWithEmailAndPassword(auth, e, p).catch(a => alert(a.message));
        else signInWithEmailAndPassword(auth, e, p).catch(a => alert(a.message));
    };

    window.signOutUser = () => signOut(auth);

    onAuthStateChanged(auth, async (u) => {
        if(u) {
            const d = await getDoc(doc(db, "users", u.uid));
            if(!d.exists()) {
                profile = { name: u.email.split('@')[0], xp: 0, avatar: "https://via.placeholder.com/150", role: 'user' };
                await setDoc(doc(db, "users", u.uid), profile);
            } else {
                profile = d.data();
            }
            initApp();
        } else {
            document.getElementById('authBox').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            document.getElementById('headerActions').classList.add('hidden');
        }
    });

    function initApp() {
        document.getElementById('authBox').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('headerActions').classList.remove('hidden');
        document.getElementById('myAvatar').src = profile.avatar;
        document.getElementById('myUser').innerText = profile.name;
        document.getElementById('myXP').innerText = profile.xp;
        document.getElementById('lvlDisplay').innerText = `[LVL ${Math.floor(profile.xp/100)}]`;
        loadFeed();
    }

    window.setTab = (t) => {
        ['feed', 'profile', 'chats'].forEach(v => {
            document.getElementById('view-'+v).classList.add('hidden');
            document.getElementById('btn-'+v).classList.remove('active');
        });
        document.getElementById('view-'+t).classList.remove('hidden');
        document.getElementById('btn-'+t).classList.add('active');
    };

    window.sendNewPost = async () => {
        const txt = document.getElementById('postMsg').value;
        const file = document.getElementById('postImg').files[0];
        let imgUrl = "";

        if(!txt && !file) return;

        if(file) {
            const fd = new FormData(); fd.append("image", file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {method:"POST", body:fd});
            const j = await res.json(); imgUrl = j.data.url;
        }

        await addDoc(collection(db, "posts"), {
            txt, img: imgUrl, uid: auth.currentUser.uid, 
            uName: profile.name, uAv: profile.avatar, 
            xp: profile.xp, time: serverTimestamp()
        });

        await updateDoc(doc(db, "users", auth.currentUser.uid), { xp: profile.xp + 10 });
        document.getElementById('postMsg').value = "";
        document.getElementById('postImg').value = "";
    };

    function loadFeed() {
        const q = query(collection(db, "posts"), orderBy("time", "desc"), limit(25));
        onSnapshot(q, s => {
            const list = document.getElementById('feedList');
            list.innerHTML = "";
            s.forEach(res => {
                const p = res.data();
                list.innerHTML += `
                    <div class="post">
                        ${profile.role === 'admin' ? `<button class="admin-btn" onclick="delPost('${res.id}')">Удалить</button>` : ''}
                        <div class="post-header">
                            <img src="${p.uAv}" class="avatar" onclick="startChat('${p.uid}', '${p.uName}')">
                            <div>
                                <b>${p.uName}</b> <span class="badge">${p.xp} XP</span>
                            </div>
                        </div>
                        <div style="word-wrap: break-word;">${p.txt}</div>
                        ${p.img ? `<img src="${p.img}" class="post-img">` : ''}
                    </div>`;
            });
        });
    }

    window.saveAvatar = async () => {
        const file = document.getElementById('newAvatar').files[0];
        if(!file) return;
        const fd = new FormData(); fd.append("image", file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {method:"POST", body:fd});
        const j = await res.json();
        await updateDoc(doc(db, "users", auth.currentUser.uid), { avatar: j.data.url });
        location.reload();
    };

    window.startChat = (toId, toName) => {
        if(toId === auth.currentUser.uid) return;
        const msg = prompt(`Написать ${toName}:`);
        if(msg) {
            const cId = [auth.currentUser.uid, toId].sort().join("_");
            addDoc(collection(db, "chats", cId, "messages"), {
                sender: profile.name, text: msg, time: serverTimestamp()
            });
            alert("Сообщение отправлено!");
        }
    };

    window.delPost = (id) => deleteDoc(doc(db, "posts", id));
</script>
</body>
</html>
